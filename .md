<!-- # @app.route('/dashboard')
# @login_required
# def dashboard():
#     # --- Sales per product ---
#     sales_data = product_sales()
#     sales_labels = [row['name'] for row in sales_data]
#     sales_values = [float(row['total_sales']) for row in sales_data]

#     # --- Profit per product ---
#     profit_data = product_profit()
#     profit_labels = [row['name'] for row in profit_data]
#     profit_values = [float(row['profit']) for row in profit_data]

#     # --- Daily sales ---
#     daily_sales_data = daily_sales()
#     daily_sales_labels = [row['day'].strftime('%Y-%m-%d') for row in daily_sales_data]
#     daily_sales_values = [float(row['total_sales']) for row in daily_sales_data]

#     # --- Daily profit ---
#     daily_profit_data = daily_profit()
#     daily_profit_labels = [row['day'].strftime('%Y-%m-%d') for row in daily_profit_data]
#     daily_profit_values = [float(row['total_profit']) for row in daily_profit_data]

#     # --- Summary totals ---
#     total_products = count_products()
#     total_sales = calculate_total_sales()
#     total_stock = calculate_total_stock()
#     total_profit = calculate_total_profit()
#     total_loss = calculate_total_loss()
#     total_transactions = count_sales_entries()

#     return render_template(
#         'dashboard.html',
#         # Chart data
#         sales_labels=sales_labels,
#         sales_values=sales_values,
#         profit_labels=profit_labels,
#         profit_values=profit_values,
#         daily_sales_labels=daily_sales_labels,
#         daily_sales_values=daily_sales_values,
#         daily_profit_labels=daily_profit_labels,
#         daily_profit_values=daily_profit_values,

#         # Summary totals
#         total_products=total_products,
#         total_sales=total_sales,
#         total_stock=total_stock,
#         total_profit=total_profit,
#         total_loss=total_loss,
#         total_transactions=total_transactions
#     ) -->

def fetch_user_by_id(user_id):
    """
    Fetch a user by ID using the fetch_data('users') helper.
    Compatible with tuple-based rows (no cursor_factory).
    """
    users = fetch_data('users') or []

    # Check if data is a list of tuples (e.g., [(1, 'John', 'email', ...)])
    # or a list of dicts (e.g., [{'id': 1, 'full_name': 'John', ...}])
    for u in users:
        if isinstance(u, dict):
            # Dict-style row (when cursor_factory=RealDictCursor)
            if str(u.get('id')) == str(user_id):
                return u
        elif isinstance(u, tuple):
            # Tuple-style row (standard cursor)
            # Adjust indexes based on your 'users' table column order
            # Example: (id, full_name, email, phone_number, password)
            if str(u[0]) == str(user_id):  
                return {
                    'id': u[0],
                    'full_name': u[1],
                    'email': u[2],
                    'phone_number': u[3],
                    'password': u[4]
                }
    return None


def get_sales_per_day():
    query = """
        SELECT DATE(s.created_at) AS day,
               SUM(p.selling_price * s.quantity) AS total_sales
        FROM sales AS s
        JOIN products AS p ON s.pid = p.id
        GROUP BY DATE(s.created_at)
        ORDER BY DATE(s.created_at);
    """
    curr.execute(query)
    data = curr.fetchall()
    return data

@app.route('/dashboard')
@login_required
def dashboard():
    # Get sales per day data from database
    sales_data = get_sales_per_day()

    # Unpack results into separate lists
    dates = [row[0].strftime('%Y-%m-%d') for row in sales_data]
    sales_per_day = [float(row[1] or 0) for row in sales_data]

    # Render dashboard template with chart data
    return render_template(
        'dashboard.html',
        dates=dates,
        sales_per_day=sales_per_day
    )

def get_profit_per_day():
    query = """
        SELECT DATE(s.created_at) AS day,
               SUM((p.selling_price - p.cost_price) * s.quantity) AS total_profit
        FROM sales AS s
        JOIN products AS p ON s.pid = p.id
        GROUP BY DATE(s.created_at)
        ORDER BY DATE(s.created_at);
    """
    curr.execute(query)
    data = curr.fetchall()
    return data

@app.route('/profit_dashboard')
@login_required
def profit_dashboard():
    # Fetch profit data from the database
    profit_data = get_profit_per_day()

    # Unpack tuples into separate lists
    dates = [row[0].strftime('%Y-%m-%d') for row in profit_data]
    profit_per_day = [float(row[1] or 0) for row in profit_data]

    # Render the profit dashboard template
    return render_template(
        'profit_dashboard.html',
        dates=dates,
        profit_per_day=profit_per_day
    )




<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const labels = [{% for d in dates %}'{{ d }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const profitData = [{% for p in profit_per_day %}{{ p }}{% if not loop.last %}, {% endif %}{% endfor %}];

  const data = {
    labels: labels,
    datasets: [{
      label: 'Profit per Day',
      data: profitData,
      backgroundColor: "rgba(75, 192, 192, 0.6)",
      borderColor: "#4bc0c0",
      borderWidth: 1
    }]
  };

  const config = {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Profit per Day'
        },
        legend: {
          display: true,
          position: 'bottom'
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Date'
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Profit (KSh)'
          }
        }
      }
    }
  };

  new Chart(document.getElementById('profit-chart'), config);
</script>